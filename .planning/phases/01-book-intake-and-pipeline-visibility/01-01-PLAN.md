---
phase: 01-book-intake-and-pipeline-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/intake.ts
  - convex/intakeMetadata.ts
  - convex/books.ts
autonomous: true
must_haves:
  truths:
    - "Manual upload and discovery both enter the same idempotent intake pipeline."
    - "Manual upload creates a visible book record immediately and auto-queues intake work."
    - "Discovery creates visible candidate rows before enqueue and keeps failed records visible."
    - "Job lifecycle is durable and normalized to queued/running/completed/failed."
  artifacts:
    - path: "convex/schema.ts"
      provides: "Canonical status enums, discovery candidate model, and indexes for dedupe lookups"
      contains: "queued|running|completed|failed"
    - path: "convex/intake.ts"
      provides: "Unified enqueue/discovery mutations with source-specific dedupe policy and override"
      exports: ["enqueueUpload", "createDiscoveryCandidates", "enqueueDiscoveryCandidate"]
    - path: "convex/intakeMetadata.ts"
      provides: "Metadata extraction action using ctx.storage.get with durable state transitions"
      exports: ["extractAndPersist"]
  key_links:
    - from: "convex/intake.ts"
      to: "convex/intakeMetadata.ts"
      via: "ctx.scheduler.runAfter"
      pattern: "runAfter\(0, internal\.intakeMetadata\.extractAndPersist"
    - from: "convex/intake.ts"
      to: "convex/schema.ts"
      via: "gutenberg dedupe lookups"
      pattern: "withIndex\(\"by_gutenberg_id\""
    - from: "convex/intakeMetadata.ts"
      to: "books and jobs tables"
      via: "state updates on success/failure"
      pattern: "status: \"(completed|failed)\""
---

<objective>
Create the backend intake foundation for Phase 1: one shared pipeline for manual upload and discovery with durable jobs, source-aware dedupe, and metadata extraction.

Purpose: Ensure all intake paths behave consistently and satisfy locked intake/dedupe decisions before UI wiring.
Output: Convex schema and intake functions that can create records, enqueue work, and persist failed states.
</objective>

<execution_context>
@/Users/boss/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/boss/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-book-intake-and-pipeline-visibility/01-CONTEXT.md
@.planning/phases/01-book-intake-and-pipeline-visibility/01-RESEARCH.md
@convex/schema.ts
@convex/books.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Normalize intake schema and candidate/job state model</name>
  <files>convex/schema.ts</files>
  <action>Update schema to support Phase 1 intake behavior: canonical job statuses `queued|running|completed|failed`, intake stage/progress/error fields for jobs, and discovery candidate storage that keeps rows visible before and after enqueue. Add indexes for dedupe checks (`by_gutenberg_id`) and candidate/status queries. Keep metadata-failure records retained (never auto-delete failed books/candidates).</action>
  <verify>Run `npm run lint` and confirm Convex schema/type generation succeeds with no status enum mismatches.</verify>
  <done>Schema supports durable status transitions, candidate visibility lifecycle, and Gutenberg-ID dedupe lookup required by locked decisions.</done>
</task>

<task type="auto">
  <name>Task 2: Implement unified idempotent intake mutations with source-specific dedupe</name>
  <files>convex/intake.ts, convex/books.ts</files>
  <action>Create a single intake orchestration module used by both manual upload and discovery enqueue. Manual upload mutation must create a visible book record immediately, create queued job row, and auto-schedule metadata extraction. Discovery flow must first create visible candidate rows, then enqueue selected candidates via explicit operator action. Enforce default duplicate block by Gutenberg ID, return duplicate context (including existing book id) for inline UI linking, and require explicit `overrideDuplicate` to allow intentional duplicate imports. Keep manual and discovery dedupe behavior intentionally distinct by source while still honoring Gutenberg ID block as default.</action>
  <verify>Use `npx convex run intake.createDiscoveryCandidates '{"limit":5}'` (or equivalent args) and `npx convex run intake.enqueueUpload '{...}'` to confirm duplicate-block responses and successful enqueue payloads are returned deterministically.</verify>
  <done>Both intake sources call the same pipeline entrypoint pattern, dedupe is idempotent and source-aware, and duplicate responses include data needed for inline link UX.</done>
</task>

<task type="auto">
  <name>Task 3: Add metadata extraction action with durable failure handling</name>
  <files>convex/intakeMetadata.ts</files>
  <action>Implement metadata extraction as an internal Convex action that reads raw text via `ctx.storage.get`, parses Gutenberg header markers (`Title:`, `Author:`, start/end markers), patches book metadata, and updates job stage/progress through queued->running->completed. On parse/storage failures, set status to failed, store error snippet/details fields, and keep associated record visible for operator review.</action>
  <verify>Run `npm run lint`, then execute one successful and one forced-failure intake path with `npx convex run` calls and confirm jobs end in `completed` and `failed` respectively without row deletion.</verify>
  <done>Metadata extraction is action-based, transitions are durable, and failed extraction keeps records with failed status as required.</done>
</task>

</tasks>

<verification>
Confirm backend supports both intake sources with shared orchestration, durable status lifecycle, and deterministic dedupe behavior before UI plans execute.
</verification>

<success_criteria>
ING-01/ING-02 backend prerequisites exist, ING-03 extraction pipeline is implemented, and OPS-01 status model is canonical (`queued/running/completed/failed`) with failure persistence.
</success_criteria>

<output>
After completion, create `.planning/phases/01-book-intake-and-pipeline-visibility/01-book-intake-and-pipeline-visibility-01-SUMMARY.md`
</output>
