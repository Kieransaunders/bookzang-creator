---
phase: 01-book-intake-and-pipeline-visibility
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/components/ImportModal.tsx
  - src/components/LibraryPage.tsx
  - src/components/DiscoveryCandidatesPanel.tsx
  - src/components/Dashboard.tsx
  - scripts/discover-library.ts
  - package.json
autonomous: true
must_haves:
  truths:
    - "Operator can upload a local file and immediately see a new book row without waiting for metadata completion."
    - "Discovery lists all candidates by default before enqueue, including Gutenberg ID, title/author, and source path."
    - "Duplicate block feedback appears inline with a link to the existing book, with explicit override for intentional duplicates."
    - "Enqueued candidates remain visible and show their status transitions instead of disappearing."
  artifacts:
    - path: "src/components/ImportModal.tsx"
      provides: "Manual upload flow using Convex upload URL -> enqueue pipeline"
    - path: "src/components/DiscoveryCandidatesPanel.tsx"
      provides: "Candidate table with warnings, enqueue controls, duplicate feedback, and persistent rows"
    - path: "scripts/discover-library.ts"
      provides: "Local scanner for library/epub/<numeric-id>/pg*.txt using ConvexHttpClient"
  key_links:
    - from: "src/components/ImportModal.tsx"
      to: "api.intake.enqueueUpload"
      via: "upload URL flow then enqueue"
      pattern: "generateUploadUrl.*fetch.*enqueueUpload"
    - from: "scripts/discover-library.ts"
      to: "api.intake.createDiscoveryCandidates"
      via: "ConvexHttpClient mutation"
      pattern: "ConvexHttpClient.*api\.intake\.createDiscoveryCandidates"
    - from: "src/components/DiscoveryCandidatesPanel.tsx"
      to: "api.intake.enqueueDiscoveryCandidate"
      via: "enqueue action with override toggle"
      pattern: "overrideDuplicate"
---

<objective>
Implement the operator-facing intake UX: manual upload path, discovery candidate visibility, and local discovery ingestion script.

Purpose: Deliver ingestion controls that expose pre-enqueue candidate decisions while preserving dedupe safety and explicit override behavior.
Output: Updated dashboard intake UI plus a runnable local discovery scanner that feeds candidate rows.
</objective>

<execution_context>
@/Users/boss/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/boss/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-book-intake-and-pipeline-visibility/01-CONTEXT.md
@.planning/phases/01-book-intake-and-pipeline-visibility/01-RESEARCH.md
@src/components/ImportModal.tsx
@src/components/LibraryPage.tsx
@src/components/Dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire manual upload to immediate record creation and auto-start intake</name>
  <files>src/components/ImportModal.tsx, src/components/LibraryPage.tsx</files>
  <action>Replace placeholder/manual metadata entry behavior with the Convex upload URL flow (`generateUploadUrl -> POST file -> enqueue upload mutation`). Remove fake timeout job simulation. Ensure successful upload immediately creates a visible book row and starts the intake pipeline automatically without a second user action. Surface inline duplicate block state from backend responses and provide explicit override toggle before retrying enqueue for intentional duplicates.</action>
  <verify>Run `npm run lint`, upload a `.txt` file in the UI, and confirm a new book row appears immediately with pipeline activity starting automatically.</verify>
  <done>Manual upload fulfills locked decisions: immediate visible record, auto-start intake, default dedupe block by Gutenberg ID, and explicit override path for intentional duplicates.</done>
</task>

<task type="auto">
  <name>Task 2: Build discovery candidates panel with pre-enqueue visibility and warnings</name>
  <files>src/components/DiscoveryCandidatesPanel.tsx, src/components/LibraryPage.tsx, src/components/Dashboard.tsx</files>
  <action>Add a discovery candidates view that lists all discovered candidates by default before enqueue. Each row must include Gutenberg ID, title/author, and source path; low-confidence or missing metadata must remain visible with warning indicators. Provide enqueue controls per candidate, inline duplicate-block warning with link to existing book, and explicit override toggle. After enqueue, keep row visible and render status transitions in-place rather than removing it.</action>
  <verify>Open dashboard discovery view and confirm rows render required fields/warnings, duplicate feedback appears inline with link, and enqueued rows stay visible while status changes.</verify>
  <done>Discovery UX satisfies locked candidate-row requirements and source-specific dedupe interaction expectations.</done>
</task>

<task type="auto">
  <name>Task 3: Add local discovery scanner script and runnable npm command</name>
  <files>scripts/discover-library.ts, package.json</files>
  <action>Create a Node script that scans `library/epub/<numeric-id>/pg*.txt`, derives candidate metadata from file/header context, and upserts candidates through `ConvexHttpClient` using intake discovery mutations. Add an npm script entry for repeatable execution. Keep script idempotent so reruns update existing candidate rows rather than creating duplicates unless override flow is explicitly used later.</action>
  <verify>Run the discovery command locally (for example `npm run discover:library`) and confirm candidates appear/reactively update in the dashboard list.</verify>
  <done>Local discovery path exists and reliably feeds candidate rows for operator enqueue decisions.</done>
</task>

</tasks>

<verification>
Validate the full ingestion operator flow end-to-end: run discovery script, review candidates, enqueue selected rows, and verify manual uploads create visible records immediately.
</verification>

<success_criteria>
ING-01 and ING-02 are operational from the dashboard workflow, with locked candidate/dedupe UX rules implemented and no disappearing rows after enqueue.
</success_criteria>

<output>
After completion, create `.planning/phases/01-book-intake-and-pipeline-visibility/01-book-intake-and-pipeline-visibility-02-SUMMARY.md`
</output>
