---
phase: 02-text-cleanup-and-editorial-approval
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/cleanup.ts
  - convex/cleanupPipeline.ts
  - convex/cleanupChaptering.ts
  - convex/cleanupFlags.ts
  - src/lib/cleanupText.ts
autonomous: true
must_haves:
  truths:
    - "Cleaned text removes Gutenberg boilerplate while preserving readable paragraph structure."
    - "Clearly labeled chapter headings are split into chapters, while front/back matter stays as labeled sections."
    - "Unlabeled section breaks are stored as review-required candidates and never auto-promoted to chapters."
    - "If no chapter headings exist, content is represented as a single body chapter."
  artifacts:
    - path: "convex/schema.ts"
      provides: "Cleanup tables for immutable original text, cleaned revisions, chapter segments, and review flags"
      contains: "cleanupRevisions"
    - path: "convex/cleanupChaptering.ts"
      provides: "Deterministic chapter boundary detection and heading normalization helpers"
      exports: ["detectChapterBoundaries", "normalizeChapterTitle"]
    - path: "convex/cleanupPipeline.ts"
      provides: "Deterministic cleanup transforms for boilerplate removal and balanced paragraph unwrapping"
      exports: ["runDeterministicCleanup"]
    - path: "convex/cleanup.ts"
      provides: "Public cleanup mutation/query surface for starting cleanup and loading review data"
      exports: ["startCleanup", "getReviewData", "listReviewFlags"]
  key_links:
    - from: "convex/cleanup.ts"
      to: "convex/cleanupPipeline.ts"
      via: "mutation invokes internal deterministic pipeline"
      pattern: "runMutation\\(internal\\.cleanupPipeline"
    - from: "convex/cleanupPipeline.ts"
      to: "convex/cleanupChaptering.ts"
      via: "pipeline consumes chapter detection output"
      pattern: "detectChapterBoundaries"
    - from: "convex/cleanupPipeline.ts"
      to: "convex/cleanupFlags.ts"
      via: "unlabeled/low-confidence candidates persisted as unresolved flags"
      pattern: "createReviewFlag"
---

<objective>
Build the deterministic cleanup foundation for Phase 2: text normalization, chapter segmentation, and persisted reviewer flags before any AI pass.

Purpose: Lock in non-negotiable structure rules from CONTEXT.md so AI cleanup and editorial review operate on stable, auditable artifacts.
Output: New Convex cleanup data model and deterministic pipeline that produces original + cleaned revisions, chapters, and unresolved review flags.
</objective>

<execution_context>
@/Users/boss/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/boss/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-CONTEXT.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-text-cleanup-and-editorial-approval-RESEARCH.md
@convex/schema.ts
@convex/intakeMetadata.ts
@src/components/LibraryPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema for immutable cleanup revisions, chapters, and flags</name>
  <files>convex/schema.ts</files>
  <action>Add cleanup data structures required for review-grade editing: immutable original text snapshot, versioned cleaned revisions, per-section chapter metadata, and review flags with unresolved/resolved state. Include fields to preserve source voice policy (`preserveArchaic=true` intent), chapter type labels (`chapter`, `preface`, `introduction`, `notes`, `appendix`, `body`), and reviewer-confirmation requirement for unlabeled boundaries. Keep backward compatibility for existing Phase 1 books/jobs tables.</action>
  <verify>Run `npm run lint` and confirm Convex schema/type generation succeeds with new cleanup tables and indexes.</verify>
  <done>Schema can persist original + cleaned text versions, normalized chapter sections, and unresolved reviewer flags required by locked decisions.</done>
</task>

<task type="auto">
  <name>Task 2: Implement deterministic cleanup and chaptering modules</name>
  <files>convex/cleanupPipeline.ts, convex/cleanupChaptering.ts, src/lib/cleanupText.ts</files>
  <action>Implement deterministic-first transforms: strip Gutenberg boilerplate envelope safely, apply balanced paragraph unwrapping only when continuation signals are strong, and run high-confidence punctuation normalization only for standard punctuation cases. Implement chapter detection rules that (a) always split clearly labeled headings, (b) accept obvious OCR-corrupted headings when intent is clear, (c) continue splitting across valid style switches (Roman/numeric), (d) keep very short chapters, (e) normalize heading output format consistently, (f) preserve preface/introduction/notes/appendix as labeled sections, and (g) emit single `body` chapter when no headings are found. For unlabeled breaks, create candidate flags for reviewer confirmation instead of auto-splitting.</action>
  <verify>Run `npm run lint` and execute deterministic cleanup against at least one Gutenberg sample via `npx convex run cleanup:startCleanup '{"bookId":"<id>"}'` to verify chapter records and flag records are created.</verify>
  <done>Deterministic pipeline enforces all locked chapter + cleanup boundaries and records ambiguity as review tasks rather than irreversible edits.</done>
</task>

<task type="auto">
  <name>Task 3: Add public cleanup API and flag lifecycle helpers</name>
  <files>convex/cleanup.ts, convex/cleanupFlags.ts</files>
  <action>Create public queries/mutations for starting deterministic cleanup, retrieving review payloads (original text, latest cleaned revision, chapter list, unresolved flags), and resolving reviewer-confirmation items for unlabeled boundaries. Ensure manual resolution can promote a boundary to chapter split or keep as non-chapter without data loss. Keep cleanup flow deterministic-first per research recommendation; AI is a later plan and should plug into this API surface without changing persistence contracts.</action>
  <verify>Run `npm run lint` and `npx convex run cleanup:getReviewData '{"bookId":"<id>"}'` to confirm payload includes original, cleaned revision, chapters, and unresolved flags.</verify>
  <done>Frontend can query a complete deterministic review model, and reviewer decisions for ambiguous boundaries can be persisted and reloaded.</done>
</task>

</tasks>

<verification>
Validate deterministic cleanup end-to-end: start cleanup on a book, confirm boilerplate removal + chapter segmentation results, and confirm unresolved ambiguous boundaries are represented as reviewer flags.
</verification>

<success_criteria>
CLEAN-01 and CLEAN-02 deterministic requirements are implemented with immutable revision storage and explicit ambiguity handling that honors all locked chapter decisions.
</success_criteria>

<output>
After completion, create `.planning/phases/02-text-cleanup-and-editorial-approval/02-text-cleanup-and-editorial-approval-01-SUMMARY.md`
</output>
