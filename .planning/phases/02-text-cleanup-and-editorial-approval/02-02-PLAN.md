---
phase: 02-text-cleanup-and-editorial-approval
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - convex/cleanupAi.ts
  - convex/cleanupAiClient.ts
  - convex/cleanupPrompts.ts
  - convex/cleanupPatchApply.ts
  - package.json
autonomous: true
user_setup:
  - service: kimi-k2
    why: "AI-assisted cleanup for OCR and punctuation improvement"
    env_vars:
      - name: KIMI_API_KEY
        source: "Kimi provider dashboard API key page"
      - name: KIMI_BASE_URL
        source: "Kimi provider API docs"
      - name: KIMI_MODEL
        source: "Kimi provider model catalog"
must_haves:
  truths:
    - "AI cleanup improves OCR and punctuation quality while preserving source-era voice and grammar defaults."
    - "Original text remains immutable while cleaned text revisions are versioned after AI edits."
    - "Low-confidence AI edits are flagged and remain unresolved until reviewer action."
  artifacts:
    - path: "convex/cleanupAi.ts"
      provides: "Internal action that requests bounded cleanup patches and writes a new cleaned revision"
      exports: ["runCleanupAiPass"]
    - path: "convex/cleanupAiClient.ts"
      provides: "Provider adapter boundary for Kimi K2 endpoint/model wiring"
      exports: ["createCleanupAiClient"]
    - path: "convex/cleanupPatchApply.ts"
      provides: "Patch validation/application logic preserving immutable originals and revision increments"
      exports: ["applyCleanupPatches"]
  key_links:
    - from: "convex/cleanupAi.ts"
      to: "convex/cleanupAiClient.ts"
      via: "provider call through adapter"
      pattern: "createCleanupAiClient"
    - from: "convex/cleanupAi.ts"
      to: "convex/cleanupPatchApply.ts"
      via: "validated patch application"
      pattern: "applyCleanupPatches"
    - from: "convex/cleanupAi.ts"
      to: "convex/cleanupFlags.ts"
      via: "low-confidence flags persisted"
      pattern: "confidence.*low"
---

<objective>
Add AI-assisted cleanup on top of deterministic outputs using a provider-adapter boundary, structured patch validation, and confidence-gated flagging.

Purpose: Deliver CLEAN-03 quality improvements without violating locked preservation and review-control decisions.
Output: AI action pipeline that produces versioned cleaned revisions and blocking low-confidence flags.
</objective>

<execution_context>
@/Users/boss/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/boss/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-CONTEXT.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-text-cleanup-and-editorial-approval-RESEARCH.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-01-PLAN.md
@convex/cleanup.ts
@convex/cleanupFlags.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and scaffold AI cleanup adapter dependencies</name>
  <files>package.json, convex/cleanupAiClient.ts, convex/cleanupPrompts.ts</files>
  <action>Install research-recommended stack `openai` and `zod` (and any missing helper dependency needed for structured patch parsing). Implement a dedicated `cleanupAiClient.ts` adapter that reads env-configured base URL/model/API key so exact Kimi endpoint/model IDs can be swapped without rewriting cleanup logic. Keep this adapter boundary explicitly because research marked provider endpoint naming as unresolved.</action>
  <verify>Run `npm install` then `npm run lint` to confirm dependency and TypeScript integrity.</verify>
  <done>AI provider integration exists behind a single adapter boundary with environment-driven Kimi configuration.</done>
</task>

<task type="auto">
  <name>Task 2: Implement structured AI patch generation and safe patch application</name>
  <files>convex/cleanupAi.ts, convex/cleanupPatchApply.ts</files>
  <action>Create internal AI action flow that receives deterministic cleaned text, requests bounded edit patches, validates payloads with zod schemas, and applies patches deterministically to produce a new cleaned revision. Enforce locked boundaries: preserve archaic spelling/grammar by default (no modernization), only standard punctuation normalization at high confidence, and best-effort cleanup for low-confidence spans while marking them for reviewer attention. Keep original text immutable and increment revision number on each AI-applied save.</action>
  <verify>Run `npm run lint` and `npx convex run cleanup:startCleanup '{"bookId":"<id>"}'` followed by AI-trigger flow; confirm a new cleaned revision is created while original revision remains unchanged.</verify>
  <done>AI changes are schema-validated, reversible via revisions, and constrained to locked cleanup policy boundaries.</done>
</task>

<task type="auto">
  <name>Task 3: Persist and expose low-confidence flags as approval blockers</name>
  <files>convex/cleanupAi.ts, convex/cleanupFlags.ts</files>
  <action>For every low-confidence patch/proposal, create unresolved reviewer flags linked to text spans and rationale so they can be resolved in review UI. Ensure unresolved low-confidence counts are queryable for approval gating in later plans. Do not auto-resolve low-confidence flags during AI pass.</action>
  <verify>Run `npx convex run cleanup:listReviewFlags '{"bookId":"<id>","status":"unresolved"}'` after AI pass and confirm low-confidence items are returned with enough context for reviewer resolution.</verify>
  <done>Low-confidence cleanup output is explicitly captured as unresolved flags and can be enforced as a hard approval gate.</done>
</task>

</tasks>

<verification>
Validate AI pass behavior end-to-end: deterministic baseline -> AI patch proposals -> validated revision write -> unresolved low-confidence flags persisted.
</verification>

<success_criteria>
CLEAN-03 is implemented with immutable original retention, versioned cleaned revisions, and confidence-gated reviewer flags.
</success_criteria>

<output>
After completion, create `.planning/phases/02-text-cleanup-and-editorial-approval/02-text-cleanup-and-editorial-approval-02-SUMMARY.md`
</output>
