---
phase: 02-text-cleanup-and-editorial-approval
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/CleanupReviewPage.tsx
  - src/components/CleanupMergeEditor.tsx
  - src/components/CleanupFlagsPanel.tsx
  - src/components/Dashboard.tsx
  - src/components/LibraryPage.tsx
  - package.json
autonomous: true
must_haves:
  truths:
    - "Reviewer sees original and cleaned text in side-by-side panes by default."
    - "Original pane is read-only while cleaned pane is editable."
    - "Diff highlights default to line/paragraph granularity."
    - "Manual edits become part of cleaned text directly with no separate marker system."
    - "Reviewer can inspect and resolve boundary/low-confidence flags from the same review workflow."
  artifacts:
    - path: "src/components/CleanupMergeEditor.tsx"
      provides: "CodeMirror merge wrapper with read-only original pane and editable cleaned pane"
    - path: "src/components/CleanupReviewPage.tsx"
      provides: "Review shell that loads review payload, save edits, and houses diff/flags UI"
    - path: "src/components/CleanupFlagsPanel.tsx"
      provides: "Unresolved flag list with resolve actions for reviewer-confirmation workflow"
  key_links:
    - from: "src/components/CleanupReviewPage.tsx"
      to: "api.cleanup.getReviewData"
      via: "review payload subscription"
      pattern: "useQuery\(api\.cleanup\.getReviewData"
    - from: "src/components/CleanupMergeEditor.tsx"
      to: "@codemirror/merge"
      via: "merge view instantiation"
      pattern: "MergeView"
    - from: "src/components/CleanupFlagsPanel.tsx"
      to: "api.cleanup.resolveReviewFlag"
      via: "reviewer resolution action"
      pattern: "useMutation\(api\.cleanup\.resolveReviewFlag"
---

<objective>
Deliver the editorial review UI with side-by-side diff, editable cleaned text, and integrated flag resolution.

Purpose: Satisfy REVIEW-01 and REVIEW-02 locked interaction requirements before approval gating is layered on top.
Output: New cleanup review page/components wired into dashboard navigation and book-level entry points.
</objective>

<execution_context>
@/Users/boss/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/boss/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-CONTEXT.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-text-cleanup-and-editorial-approval-RESEARCH.md
@src/components/Dashboard.tsx
@src/components/LibraryPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install merge editor dependencies and build side-by-side merge component</name>
  <files>package.json, src/components/CleanupMergeEditor.tsx</files>
  <action>Install `@codemirror/merge`, `codemirror`, and `diff` per research recommendation. Implement `CleanupMergeEditor` so default mode is side-by-side panes with line/paragraph highlighting, original text locked read-only, and cleaned text editable. Ensure component handles long documents without per-keystroke full-document heavy diff recompute (use debounce/incremental update strategy).</action>
  <verify>Run `npm install` and `npm run lint`, then mount component with sample texts and confirm original pane is non-editable while cleaned pane accepts edits.</verify>
  <done>Core review editor meets locked side-by-side, read-only-original, and default diff granularity requirements.</done>
</task>

<task type="auto">
  <name>Task 2: Build cleanup review page with saveable cleaned revisions</name>
  <files>src/components/CleanupReviewPage.tsx, src/components/Dashboard.tsx, src/components/LibraryPage.tsx</files>
  <action>Create page flow that opens review for a selected book, loads original/latest-cleaned/chapter metadata via cleanup queries, and saves reviewer edits to cleaned text as normal revision updates (no separate visual marker for manual edits). Wire navigation entry from existing dashboard/library workflow so each title can enter review directly after cleanup begins.</action>
  <verify>Run `npm run lint`, open review for a book, edit cleaned text, save, refresh, and confirm edited text persists as the latest cleaned revision.</verify>
  <done>Reviewer can complete side-by-side read/edit/save loop with persisted cleaned revisions and no manual-edit marker overhead.</done>
</task>

<task type="auto">
  <name>Task 3: Add unresolved flags panel for reviewer-confirmation workflows</name>
  <files>src/components/CleanupFlagsPanel.tsx, src/components/CleanupReviewPage.tsx</files>
  <action>Implement a flags panel showing unresolved items (low-confidence cleanup and unlabeled chapter-break confirmations). Provide resolve controls with explicit outcomes (confirm split vs keep merged for boundary flags, accept/reject/rewrite decisions for cleanup flags). Reflect resolution status in the review page so unresolved count updates immediately.</action>
  <verify>Trigger review data with unresolved flags, resolve at least one of each type in UI, and confirm unresolved count and list state update without reload errors.</verify>
  <done>Reviewer can act on all ambiguous/low-confidence issues directly in review workflow, preparing records for approval gating.</done>
</task>

</tasks>

<verification>
Validate full review workflow: open title, compare original vs cleaned side-by-side, edit cleaned text, and resolve flagged items in one page.
</verification>

<success_criteria>
REVIEW-01 and REVIEW-02 are met with side-by-side diff editing, read-only original, and integrated reviewer flag resolution.
</success_criteria>

<output>
After completion, create `.planning/phases/02-text-cleanup-and-editorial-approval/02-text-cleanup-and-editorial-approval-03-SUMMARY.md`
</output>
