---
phase: 02-text-cleanup-and-editorial-approval
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - convex/cleanup.ts
  - convex/cleanupFlags.ts
  - convex/books.ts
  - src/components/ApprovalChecklistDialog.tsx
  - src/components/CleanupReviewPage.tsx
  - src/components/TemplatesPage.tsx
autonomous: true
must_haves:
  truths:
    - "Reviewer approves cleaned text only after checklist confirmation, not single-click approval."
    - "Approval is blocked when unresolved low-confidence flags remain."
    - "Approved titles unlock downstream template/export actions for that specific book."
    - "If cleaned text is edited after approval, save flow prompts keep or revoke approval."
  artifacts:
    - path: "convex/cleanup.ts"
      provides: "Approval mutation/checklist persistence plus revision-aware post-approval edit handling"
      exports: ["approveCleanup", "saveCleanedText", "getApprovalState"]
    - path: "src/components/ApprovalChecklistDialog.tsx"
      provides: "Checklist confirmation dialog required before approval"
    - path: "src/components/TemplatesPage.tsx"
      provides: "Downstream action lock/unlock UI based on per-title approval state"
  key_links:
    - from: "src/components/ApprovalChecklistDialog.tsx"
      to: "api.cleanup.approveCleanup"
      via: "approval submit with checklist confirmations"
      pattern: "useMutation\(api\.cleanup\.approveCleanup"
    - from: "convex/cleanup.ts"
      to: "convex/cleanupFlags.ts"
      via: "backend unresolved-flag gate"
      pattern: "unresolved.*>\s*0"
    - from: "src/components/CleanupReviewPage.tsx"
      to: "api.cleanup.saveCleanedText"
      via: "post-approval edit save with keep/revoke prompt"
      pattern: "keepApproval"
---

<objective>
Implement approval gating and downstream unlock behavior so only reviewer-approved cleaned text can progress to template/export workflows.

Purpose: Complete REVIEW-03 and CLEAN-05 safety controls by preventing accidental progression with unresolved uncertainty.
Output: Checklist-gated approval flow, backend hard-block enforcement, and post-approval edit keep/revoke handling.
</objective>

<execution_context>
@/Users/boss/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/boss/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-CONTEXT.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-text-cleanup-and-editorial-approval-RESEARCH.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-02-PLAN.md
@.planning/phases/02-text-cleanup-and-editorial-approval/02-03-PLAN.md
@src/components/CleanupReviewPage.tsx
@src/components/TemplatesPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backend approval mutations with unresolved-flag hard gate</name>
  <files>convex/cleanup.ts, convex/cleanupFlags.ts, convex/books.ts</files>
  <action>Implement approval state model and mutation(s) that require checklist confirmation payload and reject approval when unresolved low-confidence flags exist. Enforce this gate in backend transaction logic (not UI-only) per research and locked decisions. Update per-book downstream readiness state so approved titles can unlock template/export actions while unapproved titles stay blocked. Include approval metadata (`approvedAt`, reviewer id, approved revision number) for auditability.</action>
  <verify>Run `npm run lint`; call approval mutation with unresolved flags (expect rejection) and after resolving flags (expect success + downstream-ready state update for that book).</verify>
  <done>Approval cannot bypass unresolved uncertainty and downstream unlock state is persisted per title.</done>
</task>

<task type="auto">
  <name>Task 2: Build checklist confirmation dialog and approval controls in review page</name>
  <files>src/components/ApprovalChecklistDialog.tsx, src/components/CleanupReviewPage.tsx</files>
  <action>Add approval CTA in review page that opens a checklist dialog (wording/details at Claude discretion). Require explicit confirmation items before mutation submission; no one-click approve path. Integrate unresolved-flag status display so reviewers understand why approval is blocked and what to resolve first.</action>
  <verify>Run `npm run lint`, open review page, attempt approval with unresolved flags (blocked), resolve flags, complete checklist, and confirm approval succeeds.</verify>
  <done>Approval flow requires checklist confirmations and clearly communicates unresolved-flag blockers before allowing progression.</done>
</task>

<task type="auto">
  <name>Task 3: Enforce post-approval keep/revoke prompt and downstream UI unlock behavior</name>
  <files>src/components/CleanupReviewPage.tsx, src/components/TemplatesPage.tsx</files>
  <action>When reviewer saves edits after approval, require save-time prompt offering keep approval for current revision or revoke approval. Persist reviewer choice through `saveCleanedText` mutation and keep approval state revision-aware. Update template/export entry UI to unlock only for titles with valid approval and show blocked messaging for unapproved titles.</action>
  <verify>Edit approved text, choose keep then revoke paths in separate saves, and confirm downstream template controls reflect resulting approval state each time.</verify>
  <done>Post-approval edits no longer cause approval drift, and downstream actions are unlocked only when approval remains valid.</done>
</task>

</tasks>

<verification>
Validate the full end-of-phase control loop: unresolved flags block approval, checklist confirms approval intent, post-approval edits enforce keep/revoke choice, and downstream template/export actions follow approval state.
</verification>

<success_criteria>
REVIEW-03 and CLEAN-05 approval governance are fully implemented with backend enforcement and per-title downstream unlock semantics.
</success_criteria>

<output>
After completion, create `.planning/phases/02-text-cleanup-and-editorial-approval/02-text-cleanup-and-editorial-approval-04-SUMMARY.md`
</output>
