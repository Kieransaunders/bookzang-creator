# Plan 03-01: Template System and Data Model

## Goal
Build the foundation for typography templates including data models, preset system, and configuration schema.

## Success Criteria
1. `templates` table exists with full typography configuration schema
2. 3 template presets seeded (Classic, Modern, Minimal)
3. Template configuration validation working
4. `bookInteriors` table exists for export tracking

## Tasks

### 1. Schema Design (templates table)
```typescript
// convex/schema.ts additions
templates: defineTable({
  name: v.string(),
  description: v.string(),
  presetType: v.union(v.literal("classic"), v.literal("modern"), v.literal("minimal")),
  isDefault: v.boolean(),
  
  // Typography
  typography: v.object({
    fontFamily: v.string(), // "Libre Baskerville", "EB Garamond", etc.
    fontSize: v.number(), // pt
    lineHeight: v.number(), // multiplier
    paragraphIndent: v.number(), // em
    paragraphSpacing: v.number(), // pt
  }),
  
  // Layout
  layout: v.object({
    trimSize: v.object({
      width: v.number(), // inches
      height: v.number(), // inches
    }),
    marginTop: v.number(), // inches
    marginBottom: v.number(), // inches
    marginOuter: v.number(), // inches (outside edge)
    gutterBase: v.number(), // inches (inner binding edge base)
    // Gutter increases with page count
    gutterRules: v.array(v.object({
      minPages: v.number(),
      maxPages: v.number(),
      gutterWidth: v.number(), // inches
    })),
  }),
  
  // Headers & Footers
  headerFooter: v.object({
    showChapterTitle: v.boolean(),
    showBookTitle: v.boolean(),
    pageNumberPosition: v.union(
      v.literal("bottom_center"),
      v.literal("bottom_outer"),
      v.literal("none")
    ),
    pageNumberStyle: v.union(
      v.literal("arabic"),
      v.literal("roman")
    ),
  }),
  
  // Chapter styling
  chapter: v.object({
    newPageBefore: v.boolean(),
    titleStyle: v.union(v.literal("centered"), v.literal("left")),
    dropCap: v.boolean(),
  }),
})
.index("by_preset", ["presetType"])
.index("by_default", ["isDefault"])
```

### 2. Schema Design (bookInteriors table)
```typescript
bookInteriors: defineTable({
  bookId: v.id("books"),
  templateId: v.id("templates"),
  status: v.union(
    v.literal("pending"),
    v.literal("generating"),
    v.literal("completed"),
    v.literal("failed")
  ),
  
  // Generation config snapshot
  configSnapshot: v.object({
    typography: v.any(),
    layout: v.any(),
    headerFooter: v.any(),
  }),
  
  // Results
  pageCount: v.optional(v.number()),
  fileId: v.optional(v.id("_storage")),
  fileUrl: v.optional(v.string()),
  
  // KDP compliance report
  compliance: v.optional(v.object({
    trimValid: v.boolean(),
    marginsValid: v.boolean(),
    fontsEmbedded: v.boolean(),
    pageSizeValid: v.boolean(),
    overallPass: v.boolean(),
    errors: v.array(v.string()),
  })),
  
  // Metadata
  createdAt: v.number(),
  completedAt: v.optional(v.number()),
  downloadedAt: v.optional(v.number()),
  errorMessage: v.optional(v.string()),
})
.index("by_book", ["bookId"])
.index("by_status", ["status"])
```

### 3. Seed Preset Templates
Create convex mutation `templates:seedDefaults`:

**Classic Preset:**
- Font: "Libre Baskerville", 11pt
- Line height: 1.5
- Trim: 6"×9"
- Margins: 0.75" top/bottom, 0.75" outer, gutter 0.25"-0.5" based on pages
- Page numbers: bottom center, arabic
- Drop caps: true

**Modern Preset:**
- Font: "Source Serif 4", 10.5pt
- Line height: 1.6
- Trim: 5"×8"
- Margins: 0.7" top/bottom, 0.7" outer
- Page numbers: bottom outer edge
- Clean chapter breaks

**Minimal Preset:**
- Font: "EB Garamond", 11pt
- Line height: 1.4
- Trim: 5"×8"
- Margins: 0.6" all around (adjusted for gutter)
- No headers, minimal styling

### 4. Validation Functions
- `templates:validateConfig` - Check configuration completeness
- `templates:applyToBook` - Create bookInterior record from template

## Files to Create/Modify
- `convex/schema.ts` - Add tables
- `convex/templates.ts` - Queries, mutations, seed function
- `convex/templates/seed.ts` - Preset definitions

## Testing Checklist
- [ ] Schema compiles without errors
- [ ] Seed function creates 3 presets
- [ ] Can query templates by preset type
- [ ] Can create bookInterior from template

## Time Estimate
15-20 minutes
