---
phase: 03-typography-templates-and-kdp-interior-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/templates.ts
  - convex/templates/seed.ts
autonomous: true
must_haves:
  truths:
    - "templates table exists with full typography configuration schema"
    - "3 template presets seeded (Classic, Modern, Minimal)"
    - "Template configuration validation working"
    - "bookInteriors table exists for export tracking"
  artifacts:
    - path: "convex/schema.ts"
      provides: "templates and bookInteriors table definitions"
      contains: ["templates table", "bookInteriors table"]
    - path: "convex/templates.ts"
      provides: "Template queries, mutations, and API surface"
      exports: ["list", "getById", "seedDefaults", "validateConfig", "applyToBook"]
    - path: "convex/templates/seed.ts"
      provides: "Preset template definitions for Classic, Modern, Minimal"
      exports: ["classicPreset", "modernPreset", "minimalPreset"]
  key_links:
    - from: "convex/templates.ts"
      to: "convex/schema.ts"
      via: "table queries and mutations"
      pattern: "ctx.db.query|insert|patch"
    - from: "convex/templates/seed.ts"
      to: "convex/templates.ts"
      via: "seedDefaults mutation imports presets"
      pattern: "import.*preset"
---

# Plan 03-01: Template System and Data Model

## Goal
Build the foundation for typography templates including data models, preset system, and configuration schema.

## Tasks

<task type="auto">
  <name>Task 1: Add templates table to schema</name>
  <files>convex/schema.ts</files>
  <action>
    Add templates table with:
    - Core fields: name, description, presetType (classic|modern|minimal), isDefault
    - Typography: fontFamily, fontSize (pt), lineHeight (multiplier), paragraphIndent (em), paragraphSpacing (pt)
    - Layout: trimSize (width/height inches), marginTop/Bottom/Outer (inches), gutterBase, gutterRules array
    - HeaderFooter: showChapterTitle, showBookTitle, pageNumberPosition, pageNumberStyle
    - Chapter: newPageBefore, titleStyle, dropCap
    - Indexes: by_preset, by_default
  </action>
  <verify>Run `npm run lint` and confirm Convex type generation succeeds with new templates table</verify>
  <done>Schema compiles and templates table is queryable via Convex client</done>
</task>

<task type="auto">
  <name>Task 2: Add bookInteriors table to schema</name>
  <files>convex/schema.ts</files>
  <action>
    Add bookInteriors table with:
    - Relations: bookId, templateId
    - Status: pending|generating|completed|failed
    - Config snapshot: typography, layout, headerFooter objects
    - Results: pageCount, fileId (storage), fileUrl
    - Compliance: trimValid, marginsValid, fontsEmbedded, pageSizeValid, overallPass, errors array
    - Metadata: createdAt, completedAt, downloadedAt, errorMessage
    - Indexes: by_book, by_status
  </action>
  <verify>Run `npm run lint` and confirm Convex type generation succeeds</verify>
  <done>bookInteriors table exists with all fields and indexes</done>
</task>

<task type="auto">
  <name>Task 3: Create preset template definitions</name>
  <files>convex/templates/seed.ts, convex/templates.ts</files>
  <action>
    Create convex/templates/seed.ts with 3 preset objects:
    
    Classic Preset:
    - Font: "Libre Baskerville", 11pt, lineHeight 1.5
    - Trim: 6"×9", margins 0.75" top/bottom/outer
    - Gutter rules: 0.25" (24-150p), 0.375" (151-300p), 0.5" (301-500p), 0.625" (500p+)
    - Page numbers: bottom center, arabic
    - Drop caps: true
    
    Modern Preset:
    - Font: "Source Serif 4", 10.5pt, lineHeight 1.6
    - Trim: 5"×8", margins 0.7"
    - Page numbers: bottom outer
    - Clean chapter breaks
    
    Minimal Preset:
    - Font: "EB Garamond", 11pt, lineHeight 1.4
    - Trim: 5"×8", margins 0.6"
    - No headers, minimal styling
    
    Create convex/templates.ts with seedDefaults mutation that inserts presets if not exists.
  </action>
  <verify>Run `npx convex run templates:seedDefaults` and verify 3 templates created in dashboard</verify>
  <done>3 preset templates exist in database with correct configurations</done>
</task>

<task type="auto">
  <name>Task 4: Add template validation and application helpers</name>
  <files>convex/templates.ts</files>
  <action>
    Add to convex/templates.ts:
    - validateConfig(config): Check required fields present, margins ≥ 0.35", trim sizes valid
    - applyToBook(args): Create bookInterior record from template with config snapshot
    - list(): Query all templates
    - getById(): Query single template by ID
  </action>
  <verify>Run `npm run lint` and test queries via Convex dashboard</verify>
  <done>Can query templates and create bookInterior records from templates</done>
</task>

## Testing Checklist
- [ ] Schema compiles without errors
- [ ] Seed function creates 3 presets
- [ ] Can query templates by preset type
- [ ] Can create bookInterior from template

## Time Estimate
15-20 minutes
