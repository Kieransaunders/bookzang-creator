---
phase: 03-typography-templates-and-kdp-interior-export
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - convex/interiors/generate.ts
  - convex/interiors/templateBuilder.ts
  - convex/interiors/gutter.ts
  - package.json
autonomous: true
must_haves:
  truths:
    - "interiors:generate action creates PDFs from approved text"
    - "HTML template renders with proper typography, margins, headers/footers"
    - "Chapter detection renders chapter starts correctly"
    - "Generated PDF has correct page dimensions"
  artifacts:
    - path: "convex/interiors/generate.ts"
      provides: "Main PDF generation action using Playwright"
      exports: ["generate"]
    - path: "convex/interiors/templateBuilder.ts"
      provides: "HTML/CSS construction for interior rendering"
      exports: ["buildInteriorHTML"]
    - path: "convex/interiors/gutter.ts"
      provides: "Page-count-aware gutter calculation"
      exports: ["calculateGutter", "defaultGutterRules"]
  key_links:
    - from: "convex/interiors/generate.ts"
      to: "convex/interiors/templateBuilder.ts"
      via: "calls buildInteriorHTML with book content"
      pattern: "buildInteriorHTML\\("
    - from: "convex/interiors/templateBuilder.ts"
      to: "convex/interiors/gutter.ts"
      via: "imports gutter calculation for margin logic"
      pattern: "calculateGutter"
    - from: "convex/interiors/generate.ts"
      to: "convex/bookInteriors.ts"
      via: "updates status and fileId after generation"
      pattern: "runMutation.*update"
---

# Plan 03-02: PDF Generation Pipeline

## Goal
Build the core PDF generation engine using Playwright + Paged.js for CSS-based typography control.

## Coordination Note
⚠️ **Phase 2 Dependency:** This plan assumes Phase 2 outputs chapters in this format:
```typescript
interface Chapter {
  number: number;
  title: string;
  content: string; // Clean paragraph text, paragraphs separated by blank lines
}
```
If Phase 2 implements a different structure, templateBuilder.ts will need updates before execution.

## Tasks

<task type="auto">
  <name>Task 1: Install Playwright dependencies</name>
  <files>package.json</files>
  <action>
    Run:
    npm install playwright
    npx playwright install chromium
    
    Add to package.json scripts if needed for CI.
  </action>
  <verify>Run `npm run lint` and verify playwright imports without errors</verify>
  <done>Playwright installed and chromium browser available</done>
</task>

<task type="auto">
  <name>Task 2: Implement gutter calculation module</name>
  <files>convex/interiors/gutter.ts</files>
  <action>
    Create convex/interiors/gutter.ts with:
    - defaultGutterRules array (KDP standard):
      * 24-150 pages: 0.25"
      * 151-300 pages: 0.375"
      * 301-500 pages: 0.5"
      * 501+ pages: 0.625"
    - calculateGutter(pageCount, rules): Returns gutter width for given page count
    - Type exports for GutterRule interface
  </action>
  <verify>Run `npm run lint` and test function with sample page counts</verify>
  <done>Gutter calculation returns correct widths for all page count ranges</done>
</task>

<task type="auto">
  <name>Task 3: Build HTML template builder</name>
  <files>convex/interiors/templateBuilder.ts</files>
  <action>
    Create convex/interiors/templateBuilder.ts with buildInteriorHTML function:
    
    Parameters:
    - title, author: string
    - chapters: Array<{title, content}>
    - config: TemplateConfig from templates table
    
    Output: Complete HTML document with:
    - Paged.js CDN script
    - @page CSS rules with trim size, margins (using gutter calc for inner/outer)
    - Typography: font-family, font-size, line-height
    - Chapter styling: break-before page, title alignment
    - Paragraph styling: text-indent, spacing
    - Headers/footers: page numbers per config
    - Font loading: Google Fonts CDN links
  </action>
  <verify>Run `npm run lint` and generate sample HTML, verify valid HTML structure</verify>
  <done>HTML output contains valid Paged.js markup with all template styles applied</done>
</task>

<task type="auto">
  <name>Task 4: Implement PDF generation action</name>
  <files>convex/interiors/generate.ts</files>
  <action>
    Create convex/interiors/generate.ts with action:
    
    Args: bookInteriorId
    
    Handler steps:
    1. Fetch bookInterior + template config + book metadata
    2. Fetch approved text content from Phase 2 output (cleanupRevision)
    3. Parse chapters from stored chapter metadata
    4. Build HTML using templateBuilder
    5. Launch Playwright chromium, render HTML to PDF
    6. Upload PDF buffer to Convex storage
    7. Update bookInterior: status=completed, fileId, pageCount (from PDF)
    8. If failed: status=failed, errorMessage
    
    Use job system for progress tracking (Phase 1 infrastructure).
  </action>
  <verify>Run `npm run lint` and test generation with mock data (Phase 2 dependency)</verify>
  <done>Action generates PDF and stores in Convex storage with correct metadata</done>
</task>

<task type="auto">
  <name>Task 5: Add status management and error handling</name>
  <files>convex/interiors/generate.ts, convex/bookInteriors.ts</files>
  <action>
    Add to convex/bookInteriors.ts:
    - updateStatus(bookInteriorId, status, errorMessage?)
    - updateGenerationResults(bookInteriorId, fileId, pageCount)
    
    Ensure generate action handles:
    - Playwright launch failures
    - PDF generation timeout
    - Storage upload failures
    - All errors update status to failed with message
  </action>
  <verify>Run `npm run lint` and verify mutation types generated correctly</verify>
  <done>Status transitions work: pending → generating → completed|failed</done>
</task>

## Testing Checklist
- [ ] Can generate PDF from test book
- [ ] PDF has correct page size (measure in PDF viewer)
- [ ] Typography matches template config
- [ ] Chapters start on new pages
- [ ] Page numbers render correctly
- [ ] Gutter margins visually larger on inner edge

## Dependencies
```bash
npm install playwright
npx playwright install chromium
```

## Time Estimate
25-30 minutes
