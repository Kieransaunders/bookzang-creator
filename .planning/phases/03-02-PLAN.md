# Plan 03-02: PDF Generation Pipeline

## Goal
Build the core PDF generation engine using Playwright + Paged.js for CSS-based typography control.

## Success Criteria
1. `interiors:generate` action creates PDFs from approved text
2. HTML template renders with proper typography, margins, headers/footers
3. Chapter detection renders chapter starts correctly
4. Generated PDF has correct page dimensions

## Technical Stack Decision
**Engine:** Playwright + Paged.js
- CSS @page rules for trim size and margins
- Paged.js for pagination control
- Browser-based rendering = perfect font support

## Tasks

### 1. Set Up PDF Generation Service
```typescript
// convex/interiors/generate.ts
import { action } from "./_generated/server";
import { chromium } from "playwright";

export const generate = action({
  args: {
    bookInteriorId: v.id("bookInteriors"),
  },
  handler: async (ctx, args): Promise<void> => {
    // 1. Fetch bookInterior + book + template config
    // 2. Fetch approved text content
    // 3. Build HTML with Paged.js
    // 4. Launch Playwright, render to PDF
    // 5. Upload to Convex storage
    // 6. Update bookInterior with fileId and pageCount
  },
});
```

### 2. HTML Template Builder
Create `convex/interiors/templateBuilder.ts`:

```typescript
export function buildInteriorHTML(params: {
  title: string;
  author: string;
  chapters: Array<{ title: string; content: string }>;
  config: TemplateConfig;
}): string {
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"></script>
  <style>
    @page {
      size: ${config.layout.trimSize.width}in ${config.layout.trimSize.height}in;
      margin-top: ${config.layout.marginTop}in;
      margin-bottom: ${config.layout.marginBottom}in;
      margin-left: ${isEvenPage ? config.layout.gutter : config.layout.marginOuter}in;
      margin-right: ${isEvenPage ? config.layout.marginOuter : config.layout.gutter}in;
      
      @bottom-center {
        content: ${config.headerFooter.pageNumberPosition === "bottom_center" ? "counter(page)" : "none"};
        font-family: ${config.typography.fontFamily};
      }
    }
    
    body {
      font-family: ${config.typography.fontFamily}, serif;
      font-size: ${config.typography.fontSize}pt;
      line-height: ${config.typography.lineHeight};
    }
    
    .chapter {
      break-before: page;
    }
    
    .chapter-title {
      text-align: ${config.chapter.titleStyle};
      margin-bottom: 2em;
    }
    
    p {
      text-indent: ${config.typography.paragraphIndent}em;
      margin: 0;
    }
    
    p + p {
      margin-top: ${config.typography.paragraphSpacing}pt;
    }
  </style>
</head>
<body>
  ${chapters.map(ch => `
    <div class="chapter">
      <h1 class="chapter-title">${ch.title}</h1>
      ${ch.content.split('\n\n').map(p => `<p>${p}</p>`).join('')}
    </div>
  `).join('')}
</body>
</html>
  `;
}
```

### 3. Chapter Parsing
Reuse Phase 2 chapter detection output. Format:
```typescript
interface Chapter {
  number: number;
  title: string;
  content: string; // Clean paragraph text
}
```

### 4. Gutter Margin Logic
```typescript
function calculateGutter(pageCount: number, rules: GutterRule[]): number {
  const rule = rules.find(r => pageCount >= r.minPages && pageCount <= r.maxPages);
  return rule?.gutterWidth ?? rules[rules.length - 1].gutterWidth;
}

// KDP standard gutter rules:
const defaultGutterRules = [
  { minPages: 24, maxPages: 150, gutterWidth: 0.25 },
  { minPages: 151, maxPages: 300, gutterWidth: 0.375 },
  { minPages: 301, maxPages: 500, gutterWidth: 0.5 },
  { minPages: 501, maxPages: 9999, gutterWidth: 0.625 },
];
```

### 5. Font Loading Strategy
- Use Google Fonts CDN in HTML head
- Embed font-face declarations
- Fallback chain: "Libre Baskerville, Georgia, serif"

### 6. Pipeline Integration
Update book interior status through generation:
```
pending → generating → completed|failed
```

Report progress via job system (reuse Phase 1 jobs infrastructure).

## Files to Create/Modify
- `convex/interiors/generate.ts` - Main generation action
- `convex/interiors/templateBuilder.ts` - HTML/CSS construction
- `convex/interiors/gutter.ts` - Gutter calculation
- `package.json` - Add playwright dependency

## Dependencies
```bash
npm install playwright
npx playwright install chromium
```

## Testing Checklist
- [ ] Can generate PDF from test book
- [ ] PDF has correct page size (measure in PDF viewer)
- [ ] Typography matches template config
- [ ] Chapters start on new pages
- [ ] Page numbers render correctly
- [ ] Gutter margins visually larger on inner edge

## Time Estimate
25-30 minutes
