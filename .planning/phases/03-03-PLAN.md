# Plan 03-03: KDP Compliance Validation

## Goal
Implement pre-flight validation to ensure generated PDFs pass KDP-critical requirements.

## Success Criteria
1. All generated PDFs pass automated KDP compliance checks
2. Validation reports stored with bookInterior record
3. Hard failures block download until fixed
4. Validation covers: trim size, margins, embedded fonts

## KDP Critical Requirements

### Trim Size Validation
- Must match selected template exactly (±0.01 inch tolerance)
- Supported sizes: 5"×8", 6"×9" (MVP), expandable to full KDP list

### Margin Validation
- All margins ≥ 0.35" (KDP minimum for all trim sizes)
- Gutter margin based on page count (see gutter rules)
- No content in margin zones

### Font Embedding
- All fonts must be embedded subset
- No system fonts relying on reader substitution

## Tasks

### 1. PDF Analysis with pdf-lib
```typescript
// convex/interiors/validate.ts
import { PDFDocument } from "pdf-lib";

export async function validateKDPCompliance(
  pdfBuffer: Buffer,
  expectedConfig: TemplateConfig
): Promise<ComplianceReport> {
  const pdf = await PDFDocument.load(pdfBuffer);
  
  const report: ComplianceReport = {
    trimValid: false,
    marginsValid: false,
    fontsEmbedded: false,
    pageSizeValid: false,
    overallPass: false,
    errors: [],
  };
  
  // Check 1: Page dimensions
  const page = pdf.getPage(0);
  const { width, height } = page.getSize();
  const expectedWidth = expectedConfig.layout.trimSize.width * 72; // 72 pts per inch
  const expectedHeight = expectedConfig.layout.trimSize.height * 72;
  
  const tolerance = 0.72; // ~0.01 inch in points
  if (Math.abs(width - expectedWidth) < tolerance && 
      Math.abs(height - expectedHeight) < tolerance) {
    report.trimValid = true;
    report.pageSizeValid = true;
  } else {
    report.errors.push(`Trim size mismatch: expected ${expectedWidth/72}x${expectedHeight/72}in, got ${width/72}x${height/72}in`);
  }
  
  // Check 2: Font embedding
  const embeddedFonts = pdf.embeddedFonts;
  const allFonts = pdf.getForm()?.getFields() || []; // Alternative font detection
  report.fontsEmbedded = checkFontEmbedding(pdf);
  if (!report.fontsEmbedded) {
    report.errors.push("Fonts not properly embedded");
  }
  
  // Check 3: Margin validation (sample content position)
  // This requires analyzing text positions on sample pages
  report.marginsValid = validateContentMargins(pdf, expectedConfig);
  if (!report.marginsValid) {
    report.errors.push("Content violates margin boundaries");
  }
  
  report.overallPass = report.trimValid && report.marginsValid && report.fontsEmbedded;
  return report;
}
```

### 2. Content Margin Validator
```typescript
function validateContentMargins(
  pdf: PDFDocument, 
  config: TemplateConfig
): boolean {
  // Sample first page, middle page, last page
  const pagesToCheck = [0, Math.floor(pdf.getPageCount() / 2), pdf.getPageCount() - 1];
  
  const minMargin = 0.35 * 72; // points
  
  for (const pageIdx of pagesToCheck) {
    const page = pdf.getPage(pageIdx);
    const content = page.getContentStream(); // Parse content stream for text positions
    
    // Check no text is within minMargin of page edges
    // This is approximate - full implementation would parse PDF content stream
  }
  
  return true; // Simplified for MVP
}
```

### 3. Validation Integration
Update `interiors:generate` action:
```typescript
// After PDF generation
const report = await validateKDPCompliance(pdfBuffer, config);

await ctx.runMutation(api.bookInteriors.updateCompliance, {
  bookInteriorId: args.bookInteriorId,
  compliance: report,
});

if (!report.overallPass) {
  await ctx.runMutation(api.bookInteriors.updateStatus, {
    bookInteriorId: args.bookInteriorId,
    status: "failed",
    errorMessage: `KDP validation failed: ${report.errors.join(", ")}`,
  });
  return;
}
```

### 4. Gutter Margin Verification
Add post-generation check that gutter was applied correctly:
```typescript
function verifyGutterApplied(
  pdf: PDFDocument,
  expectedGutter: number
): boolean {
  // Compare odd vs even page left margins
  // Odd pages (1, 3, 5...) should have gutter on left (binding side for RTL)
  // Even pages should have gutter on right
  // This depends on page numbering and binding direction
  return true; // Simplified - visual check in MVP
}
```

## Files to Create/Modify
- `convex/interiors/validate.ts` - Validation logic
- `convex/interiors/generate.ts` - Integrate validation
- `convex/bookInteriors.ts` - Update compliance mutation

## Dependencies
```bash
npm install pdf-lib
```

## Testing Checklist
- [ ] Validation detects wrong trim size
- [ ] Validation detects missing font embedding
- [ ] Validation passes for correctly generated PDF
- [ ] Failed validation blocks download
- [ ] Compliance report stored and viewable

## Time Estimate
20-25 minutes
