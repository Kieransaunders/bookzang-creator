---
phase: 03-typography-templates-and-kdp-interior-export
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - convex/interiors/validate.ts
  - convex/interiors/generate.ts
  - convex/bookInteriors.ts
autonomous: true
must_haves:
  truths:
    - "All generated PDFs pass automated KDP compliance checks"
    - "Validation reports stored with bookInterior record"
    - "Hard failures block download until fixed"
    - "Validation covers: trim size, margins, embedded fonts"
  artifacts:
    - path: "convex/interiors/validate.ts"
      provides: "KDP compliance validation logic using pdf-lib"
      exports: ["validateKDPCompliance", "checkFontEmbedding", "validateContentMargins"]
    - path: "convex/interiors/generate.ts"
      provides: "Updated generation action with validation integration"
      exports: ["generate"]
  key_links:
    - from: "convex/interiors/generate.ts"
      to: "convex/interiors/validate.ts"
      via: "calls validateKDPCompliance after PDF generation"
      pattern: "validateKDPCompliance\\(pdfBuffer\\)"
    - from: "convex/interiors/validate.ts"
      to: "convex/bookInteriors.ts"
      via: "compliance report stored via updateCompliance mutation"
      pattern: "runMutation.*updateCompliance"
---

# Plan 03-03: KDP Compliance Validation

## Goal
Implement pre-flight validation to ensure generated PDFs pass KDP-critical requirements.

## Tasks

<task type="auto">
  <name>Task 1: Install pdf-lib dependency</name>
  <files>package.json</files>
  <action>
    Run: npm install pdf-lib
    
    This library will be used for PDF analysis (page dimensions, font embedding).
  </action>
  <verify>Run `npm run lint` and verify pdf-lib imports without errors</verify>
  <done>pdf-lib installed and importable</done>
</task>

<task type="auto">
  <name>Task 2: Implement trim size validation</name>
  <files>convex/interiors/validate.ts</files>
  <action>
    Create convex/interiors/validate.ts with validateKDPCompliance function:
    
    Trim validation:
    - Load PDF with PDFDocument.load()
    - Get first page size in points (width, height)
    - Convert expected trim from inches to points (* 72)
    - Check within ±0.72pt tolerance (~0.01 inch)
    - Return trimValid boolean and error message if mismatch
    
    Expected trim sizes:
    - 5"×8" = 360pt × 576pt
    - 6"×9" = 432pt × 648pt
  </action>
  <verify>Create test with known-dimension PDFs, verify pass/fail detection</verify>
  <done>Validation correctly identifies correct and incorrect trim sizes</done>
</task>

<task type="auto">
  <name>Task 3: Implement font embedding check</name>
  <files>convex/interiors/validate.ts</files>
  <action>
    Add to validate.ts:
    
    checkFontEmbedding(pdf):
    - Iterate through PDF fonts
    - Check each font is embedded (has font descriptor with embedded flag)
    - Return true only if all fonts embedded
    
    Note: pdf-lib has limited font introspection; may need to check
    font dictionary for /FontDescriptor and /FontFile2/3 entries.
  </action>
  <verify>Test with PDFs having embedded vs non-embedded fonts</verify>
  <done>Font embedding check correctly identifies missing embedded fonts</done>
</task>

<task type="auto">
  <name>Task 4: Integrate validation into generation pipeline</name>
  <files>convex/interiors/generate.ts, convex/bookInteriors.ts</files>
  <action>
    Modify generate action:
    1. After PDF generation, call validateKDPCompliance()
    2. Store compliance report in bookInterior.compliance field
    3. If overallPass is false:
       - Set status to "failed"
       - Set errorMessage to joined validation errors
       - Do NOT upload to storage (or delete if already uploaded)
    4. If overallPass is true:
       - Set status to "completed"
       - Proceed with upload
    
    Add to convex/bookInteriors.ts:
    - updateCompliance(bookInteriorId, complianceReport)
  </action>
  <verify>Test generation with invalid template (wrong trim), verify blocking</verify>
  <done>Failed validation blocks completion and stores error details</done>
</task>

## Testing Checklist
- [ ] Validation detects wrong trim size
- [ ] Validation detects missing font embedding
- [ ] Validation passes for correctly generated PDF
- [ ] Failed validation blocks download
- [ ] Compliance report stored and viewable

## Dependencies
```bash
npm install pdf-lib
```

## Time Estimate
20-25 minutes
