# Plan 03-04: Interior Export UX and Artifact Management

## Goal
Build the user interface for template selection, interior generation, and artifact download.

## Success Criteria
1. User can browse and select templates from book detail page
2. User can customize typography before generation
3. Generation progress visible with real-time updates
4. Completed interiors show compliance badge and download button
5. Previous generations stored in version history

## Tasks

### 1. Template Browser Component
```typescript
// src/components/interiors/TemplateBrowser.tsx
interface TemplateBrowserProps {
  selectedId: string | null;
  onSelect: (template: Template) => void;
}

// Shows preset cards with:
// - Preview thumbnail (generated sample)
// - Typography summary
// - Trim size badge
// - "Select" button
```

### 2. Template Customizer Panel
```typescript
// src/components/interiors/TemplateCustomizer.tsx
interface TemplateCustomizerProps {
  template: Template;
  customizations: Partial<TemplateConfig>;
  onChange: (updates: Partial<TemplateConfig>) => void;
}

// Controls for:
// - Font family dropdown (filtered to available fonts)
// - Font size slider (9pt - 14pt)
// - Line height slider (1.2 - 2.0)
// - Margin inputs (with KDP minimum validation)
// - Page number position toggle
// - Header visibility toggles
```

### 3. Generation Trigger Flow
```typescript
// src/components/interiors/GenerateInteriorButton.tsx
// Steps:
// 1. Validate book has approved text (Phase 2 gate)
// 2. Create bookInterior record with config snapshot
// 3. Trigger interiors:generate action
// 4. Poll for status updates via useQuery
```

### 4. Generation Progress Display
```typescript
// src/components/interiors/GenerationProgress.tsx
// Shows:
// - Current status: "Queued" | "Generating PDF" | "Validating" | "Complete" | "Failed"
// - Progress bar (if determinable)
// - Estimated time remaining
// - Error details if failed
```

### 5. Interior Artifacts List
```typescript
// src/components/interiors/InteriorArtifacts.tsx
// Displays on book detail page:
// - List of generated interiors (newest first)
// - Template name + trim size
// - Page count
// - Compliance badge (green check / red X)
// - Created date
// - Download button (disabled if validation failed)
// - "Use this config" button to regenerate with same settings
```

### 6. Download Handler
```typescript
// src/components/interiors/DownloadInterior.tsx
async function downloadInterior(interiorId: string) {
  // 1. Get download URL from Convex
  const { url } = await fetchMutation(api.bookInteriors.getDownloadUrl, { interiorId });
  
  // 2. Trigger browser download
  const a = document.createElement("a");
  a.href = url;
  a.download = `interior-${bookTitle}.pdf`;
  a.click();
  
  // 3. Record download timestamp
  await fetchMutation(api.bookInteriors.recordDownload, { interiorId });
}
```

### 7. Book Detail Page Integration
Add "Interior" tab to book detail page:
```typescript
// src/routes/books/$bookId.tsx
<Tabs>
  <TabsList>
    <TabsTrigger value="overview">Overview</TabsTrigger>
    <TabsTrigger value="content">Content</TabsTrigger>
    <TabsTrigger value="interior">Interior</TabsTrigger>
  </TabsList>
  
  <TabsContent value="interior">
    {hasApprovedText ? (
      <InteriorManager bookId={bookId} />
    ) : (
      <Alert>
        Complete text cleanup and approval (Phase 2) to generate interiors.
      </Alert>
    )}
  </TabsContent>
</Tabs>
```

### 8. Interior Manager Component
```typescript
// src/components/interiors/InteriorManager.tsx
// Layout:
// ┌─────────────────────────────────────────────┐
// │ Template Gallery (horizontal scroll)        │
// │ [Classic] [Modern] [Minimal] [+ Custom]     │
// ├─────────────────────────────────────────────┤
// │ Customization Panel (collapsible)           │
// │ Font: [Dropdown] Size: [Slider]             │
// ├─────────────────────────────────────────────┤
// │ [Generate Interior] Button                  │
// ├─────────────────────────────────────────────┤
// │ Previous Generations                        │
// │ ┌─────────┐ ┌─────────┐ ┌─────────┐        │
// │ │ v1.pdf  │ │ v2.pdf  │ │ v3.pdf  │        │
// │ │ ✅ 142p │ │ ✅ 142p │ │ ❌ Fail │        │
// │ │ [DL]    │ │ [DL]    │ │ [View]  │        │
// │ └─────────┘ └─────────┘ └─────────┘        │
// └─────────────────────────────────────────────┘
```

## Convex Queries/Mutations Needed
```typescript
// templates.ts
- templates:list (list all templates)
- templates:getById (single template)

// bookInteriors.ts
- bookInteriors:listByBook (paginated history)
- bookInteriors:getById (single interior details)
- bookInteriors:create (start generation)
- bookInteriors:getDownloadUrl (generate temp URL)
- bookInteriors:recordDownload (track usage)
```

## Files to Create
- `src/components/interiors/TemplateBrowser.tsx`
- `src/components/interiors/TemplateCustomizer.tsx`
- `src/components/interiors/GenerationProgress.tsx`
- `src/components/interiors/InteriorArtifacts.tsx`
- `src/components/interiors/InteriorManager.tsx`
- `src/components/interiors/DownloadInterior.tsx`

## Testing Checklist
- [ ] Can select template from gallery
- [ ] Customization changes reflect in preview
- [ ] Generate button disabled if no approved text
- [ ] Progress updates in real-time during generation
- [ ] Download works and records timestamp
- [ ] Failed interiors show error details
- [ ] Version history displays correctly

## Time Estimate
30-35 minutes
